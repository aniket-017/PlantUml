@startuml
actor SystemAdministrator
actor Customer
actor Pharmacist
participant CSX
participant Kafka
participant GenRxEngine as GE
participant EPS
participant TMX
participant ACS
participant PaymentGateway as PG

SystemAdministrator -> CSX : Connect to the network
SystemAdministrator -> Kafka : Set up Kafka
SystemAdministrator -> EPS : Set up EPS
CSX -> Kafka : Verify services are running

Customer -> CSX : Enter identification and click Continue
CSX -> Kafka : Send identification data
Kafka -> GE : Forward data to GenRx Engine
GE -> EPS : Fetch patient and prescription data
EPS -> GE : Return prescription and patient data
GE -> Kafka : Push data
Kafka -> TMX : Deliver prescription data
TMX -> Pharmacist : Display full prescription list
TMX -> CSX : Share limited details (copay amount)

Pharmacist -> TMX : Perform scan-scan validation
TMX -> Kafka : Send scanned prescription data
Kafka -> GE : Forward data
GE -> EPS : Validate safety
EPS -> GE : Return validation result
GE -> Kafka : Push validation result
Kafka -> TMX : Deliver status
TMX -> Pharmacist : Receive validation status

Pharmacist -> TMX : Initiate compliance request
TMX -> Kafka : Send request to GE
GE -> EPS : Store request
EPS -> GE : Acknowledge compliance record
GE -> Kafka : Compliance acknowledgment delivered
Kafka -> TMX : Deliver acknowledgment
TMX -> CSX : Display compliance document
Customer -> CSX : Review and sign
CSX -> TMX : Send signed document
TMX -> Kafka : Save compliance signature record to GE
Kafka -> EPS : Confirm update
GE -> Kafka : Compliance completion status delivered
Kafka -> TMX : Deliver final status

Pharmacist -> TMX : Initiate payment transaction
TMX -> Kafka : Payment request initiated
Kafka -> ACS : Forward request
ACS -> PG : Process payment
PG -> ACS : Return payment confirmation
ACS -> Kafka : Payment success notification
Kafka -> GE : Update payment details
GE -> EPS : Acknowledge update
EPS -> GE : Confirmation
GE -> Kafka : Payment success status
Kafka -> TMX : Deliver success status
TMX -> Customer : Display confirmation

Customer -> CSX : Enter invalid identification
CSX -> Kafka : Attempt to send data
CSX -> Customer : Display error for invalid data

Pharmacist -> TMX : Initiate payment with zero amount
TMX -> Kafka : Payment request for zero amount
note right of TMX: Validate edge case response

SystemAdministrator -> CSX : Disconnect from the network
SystemAdministrator -> Kafka : Shut down Kafka
SystemAdministrator -> EPS : Shut down EPS
CSX -> SystemAdministrator : Verify all services stopped

@enduml